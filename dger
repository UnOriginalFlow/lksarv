-- COUNTER BLOX ULTIMATE RAGE + RAINBOW VISUALS (Merged 2025 Meta)
-- Features: Silent Aim, No Spread, Ragebot, Bhop, Fakelag, Tracers, Rainbow ESP/Chams
-- Z = Toggle Menu, X = Toggle Rage Features

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local HttpService = game:GetService("HttpService")
local Camera = workspace.CurrentCamera
local LP = Players.LocalPlayer
local Mouse = LP:GetMouse()

-- Settings
local Settings = {
    -- Rage
    RageEnabled = false,
    SilentAim = true,
    FOV = 150,
    HitPart = "Head",
    NoSpread = true,
    AutoShoot = true,
    Bhop = true,
    Fakelag = true,
    FakelagAmount = 8,
    
    -- Visuals
    EspEnabled = true,
    Rainbow = true,
    RainbowSpeed = 2,
    Tracers = true,
    Chams = true,
    Box = true,
    Name = true,
    Health = true,
    Distance = true,
    TeamCheck = true,
    VisibleOnly = false
}

-- UI
local ScreenGui = Instance.new("ScreenGui", game.CoreGui)
ScreenGui.Name = "RageMenu"
local Main = Instance.new("Frame", ScreenGui)
Main.Size = UDim2.new(0, 380, 0, 480)
Main.Position = UDim2.new(0.5, -190, 0.5, -240)
Main.BackgroundColor3 = Color3.fromRGB(18, 18, 25)
Main.BorderSizePixel = 0
Main.Active = true
Main.Draggable = true
local Corner = Instance.new("UICorner", Main) Corner.CornerRadius = UDim.new(0, 14)

local Title = Instance.new("TextLabel", Main)
Title.Size = UDim2.new(1, 0, 0, 40)
Title.BackgroundColor3 = Color3.fromRGB(28, 28, 40)
Title.Text = "ULTIMATE CB RAGE + RAINBOW"
Title.TextColor3 = Color3.new(1,1,1)
Title.Font = Enum.Font.GothamBold
Title.TextSize = 16
local Grad = Instance.new("UIGradient", Title)
Grad.Color = ColorSequence.new{ColorSequenceKeypoint.new(0, Color3.fromRGB(255,80,180)), ColorSequenceKeypoint.new(1, Color3.fromRGB(80,180,255))}

local y = 50
local function AddToggle(name, key, default)
    local Toggle = Instance.new("TextButton", Main)
    Toggle.Size = UDim2.new(0.9, 0, 0, 32)
    Toggle.Position = UDim2.new(0.05, 0, 0, y)
    Toggle.BackgroundColor3 = Color3.fromRGB(30, 30, 45)
    Toggle.Text = name .. ": " .. (default and "ON" or "OFF")
    Toggle.TextColor3 = Color3.new(1,1,1)
    Toggle.Font = Enum.Font.Gotham
    Toggle.TextSize = 13
    local tc = Instance.new("UICorner", Toggle) tc.CornerRadius = UDim.new(0, 8)
    
    Toggle.MouseButton1Click:Connect(function()
        Settings[key] = not Settings[key]
        Toggle.Text = name .. ": " .. (Settings[key] and "ON" or "OFF")
    end)
    y = y + 40
end

AddToggle("Rage Features", "RageEnabled", false)
AddToggle("Silent Aim", "SilentAim", true)
AddToggle("No Spread", "NoSpread", true)
AddToggle("Auto Shoot", "AutoShoot", true)
AddToggle("Bunny Hop", "Bhop", true)
AddToggle("Fakelag", "Fakelag", true)
AddToggle("ESP Enabled", "EspEnabled", true)
AddToggle("Rainbow Cycle", "Rainbow", true)
AddToggle("Tracers", "Tracers", true)
AddToggle("Chams", "Chams", true)
AddToggle("Boxes", "Box", true)
AddToggle("Names", "Name", true)
AddToggle("Health", "Health", true)
AddToggle("Distance", "Distance", true)

-- Silent Aim / Ragebot
local function GetClosest()
    local closest, dist = nil, Settings.FOV
    for _, p in Players:GetPlayers() do
        if p ~= LP and p.Character and p.Character:FindFirstChild(Settings.HitPart) then
            local part = p.Character[Settings.HitPart]
            local screen = Camera:WorldToViewportPoint(part.Position)
            local mag = (Vector2.new(screen.X, screen.Y) - Vector2.new(Mouse.X, Mouse.Y + 36)).Magnitude
            if mag < dist and (not Settings.TeamCheck or p.Team ~= LP.Team) then
                closest = part
                dist = mag
            end
        end
    end
    return closest
end

local mt = getrawmetatable(game)
local old = mt.__namecall
setreadonly(mt, false)
mt.__namecall = newcclosure(function(self, ...)
    local args = {...}
    local method = getnamecallmethod()
    
    if Settings.RageEnabled then
        if method == "FireServer" and self.Name == "Shoot" then
            if Settings.NoSpread then
                args[1] = 0 -- spread
                args[2] = 0
            end
            if Settings.SilentAim and GetClosest() then
                args[3] = GetClosest().Position -- hit position
            end
        end
    end
    
    return old(self, unpack(args))
end)
setreadonly(mt, true)

-- Bhop
RunService.RenderStepped:Connect(function()
    if Settings.RageEnabled and Settings.Bhop and LP.Character and LP.Character:FindFirstChild("Humanoid") then
        if UserInputService:IsKeyDown(Enum.KeyCode.Space) then
            LP.Character.Humanoid:ChangeState("Jumping")
        end
    end
end)

-- Fakelag (basic packet choke simulation)
local lag = 0
RunService.Heartbeat:Connect(function()
    if Settings.RageEnabled and Settings.Fakelag then
        lag = lag + 1
        if lag % Settings.FakelagAmount == 0 then
            -- simulate by not sending movement (very basic)
            game:GetService("ReplicatedStorage").Movement:FireServer(LP.Character.HumanoidRootPart.CFrame)
        end
    end
end)

-- Rainbow Visuals (your upgraded ESP)
local EspFolder = Instance.new("Folder", ScreenGui)
EspFolder.Name = "Esp"

local function GetRainbow()
    return Color3.fromHSV((tick() * Settings.RainbowSpeed) % 1, 1, 1)
end

RunService.RenderStepped:Connect(function()
    if not Settings.EspEnabled then return end
    
    for _, p in Players:GetPlayers() do
        if p ~= LP and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
            local root = p.Character.HumanoidRootPart
            local color = Settings.Rainbow and GetRainbow() or Color3.fromRGB(255, 50, 50)
            
            -- Simple tracer
            if Settings.Tracers then
                local screen, onScreen = Camera:WorldToViewportPoint(root.Position)
                if onScreen then
                    local line = EspFolder:FindFirstChild(p.Name.."Tracer") or Instance.new("Frame", EspFolder)
                    line.Name = p.Name.."Tracer"
                    line.BackgroundColor3 = color
                    line.Size = UDim2.new(0, 2, 0, (Camera.ViewportSize.Y - screen.Y) * 0.8)
                    line.Position = UDim2.new(0, screen.X - 1, 0, screen.Y)
                    line.AnchorPoint = Vector2.new(0.5, 0)
                    line.Rotation = 90
                end
            end
            
            -- Chams
            if Settings.Chams then
                local hl = p.Character:FindFirstChildOfClass("Highlight") or Instance.new("Highlight", p.Character)
                hl.FillColor = color
                hl.OutlineColor = color
                hl.FillTransparency = 0.4
                hl.OutlineTransparency = 0
            end
        end
    end
end)

-- Menu toggle
UserInputService.InputBegan:Connect(function(i)
    if i.KeyCode == Enum.KeyCode.Z then
        Main.Visible = not Main.Visible
    elseif i.KeyCode == Enum.KeyCode.X then
        Settings.RageEnabled = not Settings.RageEnabled
        print("Rage " .. (Settings.RageEnabled and "ENABLED" or "DISABLED"))
    end
end)

print("ULTIMATE CB RAGE Loaded - Z = Menu | X = Toggle Rage")
