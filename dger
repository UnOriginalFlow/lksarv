local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Camera = workspace.CurrentCamera
local LocalPlayer = Players.LocalPlayer

local Boxes = {}
local Connections = {} -- Stores event connections to prevent memory leaks

local function IsEnemy(plr)
    if plr == LocalPlayer then return false end
    local myChar = LocalPlayer.Character
    local theirChar = plr.Character
    if not myChar or not theirChar then return false end
    
    -- Checks if players are parented to different folders (common for teams)
    return myChar.Parent.Name ~= theirChar.Parent.Name
end

local function CreateBox(plr)
    if Boxes[plr] then return end
    local box = Drawing.new("Square")
    box.Thickness = 1.6
    box.Filled = false
    box.Color = Color3.fromRGB(255, 0, 0)
    box.Transparency = 1
    box.Visible = false
    Boxes[plr] = box
end

local function RemoveBox(plr)
    if Boxes[plr] then
        Boxes[plr]:Remove()
        Boxes[plr] = nil
    end
end

-- Initialize boxes for existing players
for _, plr in Players:GetPlayers() do
    if plr ~= LocalPlayer then
        CreateBox(plr)
    end
end

-- Track connections so we can safely disconnect them later
table.insert(Connections, Players.PlayerAdded:Connect(CreateBox))
table.insert(Connections, Players.PlayerRemoving:Connect(RemoveBox))

table.insert(Connections, RunService.RenderStepped:Connect(function()
    for plr, box in pairs(Boxes) do
        local char = plr.Character
        if not char or not char:FindFirstChild("HumanoidRootPart") or not char:FindFirstChild("Head") then
            box.Visible = false
            continue
        end

        if not IsEnemy(plr) then
            box.Visible = false
            continue
        end

        local hrp = char.HumanoidRootPart
        local head = char.Head

        -- WorldToViewportPoint returns the position and an on-screen boolean
        local headPos, headOnScreen = Camera:WorldToViewportPoint(head.Position + Vector3.new(0, 0.5, 0))
        local rootPos, rootOnScreen = Camera:WorldToViewportPoint(hrp.Position)
        local legPos, legOnScreen = Camera:WorldToViewportPoint(hrp.Position - Vector3.new(0, 3.5, 0))

        -- Use the built-in boolean rather than relying on the Z depth calculation
        if not rootOnScreen then
            box.Visible = false
            continue
        end

        local height = math.abs(headPos.Y - legPos.Y)
        local width = height * 0.55

        box.Size = Vector2.new(width, height)
        
        -- Use headPos.Y for the top of the box to prevent vertical offset errors
        box.Position = Vector2.new(rootPos.X - width/2, headPos.Y)
        box.Visible = true
    end
end))

print("Bloxstrike ESP loaded âš¡")

-- Return a cleanup function so the user can easily unload the script later
-- Example usage: local unloadEsp = loadstring(...)(); unloadEsp();
return function()
    for _, conn in ipairs(Connections) do
        conn:Disconnect()
    end
    for plr, _ in pairs(Boxes) do
        RemoveBox(plr)
    end
    print("Bloxstrike ESP unloaded.")
end
